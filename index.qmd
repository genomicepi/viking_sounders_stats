---
title: "âš½ NK B16 Viking Sounders"
subtitle: "2025-2026 Season Statistics Dashboard"
format: 
  html:
    theme: lumen
    toc: false
    page-layout: full
    html-table-processing: none
    include-in-header: 
      text: |
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
execute:
  echo: false
  warning: false
  message: false
---

```{css}
#| echo: false

/* Clean professional styling that works with lumen theme */
.season-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.stat-box {
  text-align: center;
  padding: 20px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  transition: box-shadow 0.2s ease;
}

.stat-box:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  color: #495057;
  display: block;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9em;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.performers-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.performer-box {
  text-align: center;
  padding: 15px;
  background: #e7f3ff;
  border: 1px solid #b3d7ff;
  border-radius: 8px;
}

.performer-title {
  font-weight: bold;
  color: #0056b3;
  margin-bottom: 5px;
  font-size: 0.9em;
}

.performer-name {
  font-size: 1.1em;
  margin-bottom: 3px;
}

.performer-stat {
  font-size: 1.3em;
  font-weight: bold;
  color: #0056b3;
}

/* Section styling */
.priority-section {
  border-left: 4px solid #007bff;
  padding-left: 15px;
  margin-bottom: 30px;
}

.secondary-section {
  border-left: 4px solid #ffc107;
  padding-left: 15px;
  margin-bottom: 30px;
}

/* Clean table styling */
.custom-table {
  width: 100%;
  margin-top: 15px;
}

.custom-table th {
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  padding: 12px;
}

.custom-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #dee2e6;
}

.custom-table tbody tr:hover {
  background-color: #f8f9fa;
}

/* Clickable game rows */
.game-row {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.game-row:hover {
  background-color: #e9ecef !important;
}

/* Game detail modal styling */
.game-stats-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.game-stat-box {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
}

.game-stat-number {
  font-size: 1.8em;
  font-weight: bold;
  color: #495057;
  display: block;
}

.game-stat-label {
  font-size: 0.85em;
  color: #6c757d;
  text-transform: uppercase;
}

/* Custom modal styling */
.custom-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9998;
  overflow-y: auto;
}

.custom-modal-overlay.active {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 40px 20px;
}

.custom-modal-content {
  background: white;
  border-radius: 8px;
  max-width: 900px;
  width: 100%;
  position: relative;
  z-index: 9999;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  margin: auto;
}

.custom-modal-header {
  padding: 20px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.custom-modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.custom-modal-close:hover {
  background: #f8f9fa;
}

.custom-modal-body {
  padding: 20px;
  max-height: calc(90vh - 80px);
  overflow-y: auto;
}

/* Update notice */
.update-info {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  color: #6c757d;
  font-size: 0.9em;
}

.update-info a {
  color: #007bff;
  text-decoration: none;
}

.update-info a:hover {
  text-decoration: underline;
}

@media (max-width: 768px) {
  .season-summary, .performers-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .game-stats-summary {
    grid-template-columns: 1fr;
  }
}
```

```{r setup}
#| include: false

# Load required libraries
library(readr)
library(dplyr)
library(stringr)
library(knitr)
library(kableExtra)
library(jsonlite)

# URL to your published Google Sheet CSV
csv_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXyx3iRXjeOoTxtgtJxOqrfYwcyuvXO8Cxg1hyjzwHISViC-V6X3T45tnEvID_D8aXgQW8ucbK-l5I/pub?gid=0&single=true&output=csv"

# Function to safely read CSV with error handling
read_team_data <- function() {
  tryCatch({
    data <- read_csv(csv_url, show_col_types = FALSE)
    
    # Clean and process data
    data <- data %>%
      filter(!is.na(Date) & Date != "" & !is.na(Player) & Player != "") %>%
      filter(Type == "Fall Season")%>%
      mutate(
        # Convert Date column to proper Date type
        Date = as.Date(Date, format = "%m/%d/%y"),
        Goals = as.numeric(Goals),
        Assists = as.numeric(Assists), 
        Shots = as.numeric(Shots),
        Saves = as.numeric(Saves),
        Final_Score_Us = as.numeric(Final_Score_Us),
        Final_Score_Them = as.numeric(Final_Score_Them)
      ) %>%
      replace(is.na(.), 0)
    
    return(data)
  }, error = function(e) {
    warning("Could not load live data from Google Sheets: ", e$message)
    return(NULL)
  })
}

# Load the data
team_data <- read_team_data()

# Stop if data loading fails
if (is.null(team_data)) {
  stop("Could not load data from Google Sheets. Please check the CSV URL and internet connection.")
}
```

```{r data-processing}
#| include: false

# Process games data
games_summary <- team_data %>%
  group_by(Date, Opponent, Type, Final_Score_Us, Final_Score_Them) %>%
  summarise(.groups = 'drop') %>%
  arrange(desc(Date)) %>%
  mutate(
    Result = case_when(
      Final_Score_Us > Final_Score_Them ~ "Win",
      Final_Score_Us < Final_Score_Them ~ "Loss", 
      TRUE ~ "Tie"
    ),
    Season_Type = case_when(
      str_detect(Type, "Fall Season") ~ "Regular Season",
      TRUE ~ "Tournament"
    ),
    GameID = row_number()
  )

# Separate Fall Season and Tournament games
fall_season_games <- games_summary %>% 
  filter(str_detect(Type, "Fall Season"))

tournament_games <- games_summary %>% 
  filter(!str_detect(Type, "Fall Season"))

# Process player statistics
player_stats <- team_data %>%
  group_by(Jersey_Number, Player) %>%
  summarise(
    Goals = sum(Goals, na.rm = TRUE),
    Assists = sum(Assists, na.rm = TRUE),
    Shots = sum(Shots, na.rm = TRUE),
    Saves = sum(Saves, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  arrange(desc(Goals), desc(Assists), desc(Saves))

# Calculate statistics
fall_games_count <- nrow(fall_season_games)
fall_wins <- sum(fall_season_games$Result == "Win")
fall_goals <- sum(fall_season_games$Final_Score_Us)
fall_goals_against <- sum(fall_season_games$Final_Score_Them)

total_games <- nrow(games_summary)
total_wins <- sum(games_summary$Result == "Win")
total_goals <- sum(games_summary$Final_Score_Us)
total_goals_against <- sum(games_summary$Final_Score_Them)

# Top performers
top_scorer <- player_stats %>% 
  filter(Goals == max(Goals)) %>% 
  slice(1)

top_assists <- player_stats %>% 
  filter(Assists == max(Assists)) %>% 
  slice(1)

top_saves <- player_stats %>% 
  filter(Saves == max(Saves)) %>% 
  slice(1)

# Prepare game details data for JavaScript
game_details_list <- lapply(1:nrow(fall_season_games), function(i) {
  game <- fall_season_games[i, ]
  
  # Get player stats for this specific game
  game_players <- team_data %>%
    filter(Date == game$Date, Opponent == game$Opponent) %>%
    group_by(Jersey_Number, Player) %>%
    summarise(
      Goals = sum(Goals, na.rm = TRUE),
      Assists = sum(Assists, na.rm = TRUE),
      Shots = sum(Shots, na.rm = TRUE),
      Saves = sum(Saves, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    filter(Goals > 0 | Assists > 0 | Shots > 0 | Saves > 0) %>%
    arrange(desc(Goals), desc(Assists), desc(Saves))
  
  # Calculate team totals for this game
  team_goals <- sum(game_players$Goals, na.rm = TRUE)
  team_shots <- sum(game_players$Shots, na.rm = TRUE)
  team_saves <- sum(game_players$Saves, na.rm = TRUE)
  
  list(
    gameId = game$GameID,
    date = as.character(game$Date),
    opponent = game$Opponent,
    score = paste(game$Final_Score_Us, "-", game$Final_Score_Them),
    result = game$Result,
    teamGoals = team_goals,
    teamShots = team_shots,
    teamSaves = team_saves,
    players = game_players
  )
})
```

::: {.update-info}
[League Standings](https://northpugetsoundleague.demosphere-secure.com/_element_display/#%2F74274%2Fschedules%2FFall2025%2F115239401.html%3Frnd%3D1757902954884) | 
[Team Discussion Forum](https://community.nkb16.org) | [Full Stats Sheet (including tournaments)](https://docs.google.com/spreadsheets/d/1dqo2JAqRDvqtftlotC-uywJQRYlk--Yr3Azm6ZctpHQ/edit?usp=sharing)

:::

## ðŸ† Fall Season Overview

::: {.season-summary}
::: {.stat-box}
::: {.stat-number}
`r fall_games_count`
:::
::: {.stat-label}
Games
:::
:::

::: {.stat-box}
::: {.stat-number}
`r fall_wins`
:::
::: {.stat-label}
Wins
:::
:::

::: {.stat-box}
::: {.stat-number}
`r fall_goals`
:::
::: {.stat-label}
Goals
:::
:::

::: {.stat-box}
::: {.stat-number}
`r fall_goals_against`
:::
::: {.stat-label}
Goals Against
:::
:::
:::


## ðŸ“… Fall Season Games
<p style="text-align: center; color: #6c757d; font-size: 0.9em; margin-bottom: 10px;">
  <em>Click on any game to view detailed stats</em>
</p>

```{r fall-season-table}
#| echo: false

if (nrow(fall_season_games) > 0) {
  # Clean fall season table
  clean_fall_table <- fall_season_games %>%
    mutate(
      Score = paste(Final_Score_Us, "-", Final_Score_Them),
      Clean_Result = case_when(
        Final_Score_Us > Final_Score_Them ~ "Win",
        Final_Score_Us < Final_Score_Them ~ "Loss",
        TRUE ~ "Tie"
      )
    ) %>%
    select(Date, Opponent, Clean_Result, Score, GameID)
  
  # Create the table
  clean_fall_table %>%
    select(-GameID) %>%
    kable(
      col.names = c("Date", "Opponent", "Result", "Score"),
      table.attr = "class='table table-hover custom-table' id='games-table'"
    ) %>%
    kable_styling(bootstrap_options = c("hover", "striped")) %>%
    column_spec(3, 
      background = case_when(
        clean_fall_table$Clean_Result == "Win" ~ "#d4edda",
        clean_fall_table$Clean_Result == "Loss" ~ "#f8d7da",
        TRUE ~ "#fff3cd"
      ),
      color = case_when(
        clean_fall_table$Clean_Result == "Win" ~ "#155724",
        clean_fall_table$Clean_Result == "Loss" ~ "#721c24",
        TRUE ~ "#856404"
      ),
      bold = TRUE)
  
} else {
  cat("*No Fall Season games recorded yet.*")
}
```

```{r inject-game-data}
#| echo: false
#| results: asis

# Convert game details to JSON for JavaScript
game_data_json <- toJSON(game_details_list, auto_unbox = TRUE, pretty = TRUE)

cat('<script type="text/javascript">')
cat('const gameDetailsData = ', game_data_json, ';')
cat('</script>')
```

```{js}
#| echo: false

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('gameDetailsModal');
    if (modal && modal.style.display === 'flex') {
      modal.style.display = 'none';
    }
  }
});

// Add click handlers to game rows
document.addEventListener('DOMContentLoaded', function() {
  console.log('Setting up click handlers...');
  console.log('Game data available:', typeof gameDetailsData !== 'undefined');
  console.log('Modal exists:', document.getElementById('gameDetailsModal') !== null);
  console.log('Modal content exists:', document.getElementById('gameDetailsContent') !== null);
  
  // Find the games table - try multiple selectors
  let table = document.querySelector('#games-table tbody');
  if (!table) {
    // Fallback: find any table in the games section
    const allTables = document.querySelectorAll('table tbody');
    console.log('Found', allTables.length, 'tables');
    // The games table should be before the player stats table
    if (allTables.length >= 1) {
      table = allTables[0];
    }
  }
  
  if (table) {
    console.log('Table found, adding click handlers');
    const rows = table.querySelectorAll('tr');
    console.log('Found', rows.length, 'rows');
    
    rows.forEach((row, index) => {
      row.classList.add('game-row');
      row.style.cursor = 'pointer';
      
      row.addEventListener('click', function() {
        console.log('Row clicked:', index);
        // Use the row index to find the corresponding game
        if (typeof gameDetailsData !== 'undefined' && gameDetailsData[index]) {
          const gameData = gameDetailsData[index];
          console.log('Opening game:', gameData.opponent);
          showGameDetails(gameData.gameId);
        } else {
          console.error('Game data not found for index:', index);
        }
      });
    });
  } else {
    console.error('Games table not found');
  }
});

function showGameDetails(gameId) {
  console.log('showGameDetails called with gameId:', gameId);
  
  // Find the game data
  const gameData = gameDetailsData.find(g => g.gameId === gameId);
  
  if (!gameData) {
    console.error('Game not found:', gameId);
    return;
  }
  
  console.log('Found game data:', gameData.opponent);
  
  // Build the modal content
  let html = `
    <div style="text-align: center; margin-bottom: 20px;">
      <h4>${gameData.opponent}</h4>
      <h5 style="color: #6c757d;">${gameData.date}</h5>
      <h3 style="margin-top: 15px;">
        <span class="badge ${gameData.result === 'Win' ? 'bg-success' : gameData.result === 'Loss' ? 'bg-danger' : 'bg-warning'}">${gameData.result}</span>
        <span style="margin-left: 10px;">${gameData.score}</span>
      </h3>
    </div>
    
    <div class="game-stats-summary">
      <div class="game-stat-box">
        <span class="game-stat-number">${gameData.teamGoals}</span>
        <span class="game-stat-label">Team Goals</span>
      </div>
      <div class="game-stat-box">
        <span class="game-stat-number">${gameData.teamShots}</span>
        <span class="game-stat-label">Team Shots</span>
      </div>
      <div class="game-stat-box">
        <span class="game-stat-number">${gameData.teamSaves}</span>
        <span class="game-stat-label">Team Saves</span>
      </div>
    </div>
    
    <h5 style="margin-top: 25px; margin-bottom: 15px;">Player Statistics</h5>
  `;
  
  if (gameData.players && gameData.players.length > 0) {
    html += `
      <table class="table table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Goals</th>
            <th>Assists</th>
            <th>Shots</th>
            <th>Saves</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    gameData.players.forEach(player => {
      html += `
        <tr>
          <td>${player.Jersey_Number}</td>
          <td>${player.Player}</td>
          <td>${player.Goals > 0 ? '<strong>' + player.Goals + '</strong>' : player.Goals}</td>
          <td>${player.Assists > 0 ? '<strong>' + player.Assists + '</strong>' : player.Assists}</td>
          <td>${player.Shots}</td>
          <td>${player.Saves > 0 ? '<strong>' + player.Saves + '</strong>' : player.Saves}</td>
        </tr>
      `;
    });
    
    html += `
        </tbody>
      </table>
    `;
  } else {
    html += '<p style="text-align: center; color: #6c757d;">No player statistics recorded for this game.</p>';
  }
  
  // Insert content and show custom modal
  const contentDiv = document.getElementById('gameDetailsContent');
  const modalDiv = document.getElementById('gameDetailsModal');
  
  console.log('Content div exists:', contentDiv !== null);
  console.log('Modal div exists:', modalDiv !== null);
  
  if (contentDiv && modalDiv) {
    // Add close button to the content
    const closeBtn = '<div style="position:sticky;top:0;background:white;padding:10px;text-align:right;z-index:10000;border-bottom:2px solid #dee2e6;margin-bottom:20px;"><button onclick="document.getElementById(\'gameDetailsModal\').style.display=\'none\'" style="font-size:20px;font-weight:bold;background:#dc3545;color:white;border:none;cursor:pointer;padding:8px 20px;border-radius:5px;">âœ• CLOSE</button></div>';
    
    contentDiv.innerHTML = closeBtn + html;
    
    // Force modal to display with inline styles
    modalDiv.style.display = 'flex';
    modalDiv.style.position = 'fixed';
    modalDiv.style.top = '0';
    modalDiv.style.left = '0';
    modalDiv.style.width = '100%';
    modalDiv.style.height = '100%';
    modalDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    modalDiv.style.zIndex = '9999';
    modalDiv.style.alignItems = 'flex-start';
    modalDiv.style.justifyContent = 'center';
    modalDiv.style.opacity = '1';
    modalDiv.style.visibility = 'visible';
    modalDiv.style.padding = '40px 20px';
    modalDiv.style.overflowY = 'auto';
    
    modalDiv.classList.add('active');
  } else {
    console.error('Could not find modal elements');
  }
}
```

## ðŸ‘¥ Player Statistics

```{r players-table}
#| echo: false

player_stats %>%
  kable(
    col.names = c("#", "Player", "Goals", "Assists", "Shots", "Saves"),
    table.attr = "class='table table-hover custom-table'",
    escape = FALSE
  ) %>%
  kable_styling(bootstrap_options = "hover") %>%
  column_spec(3, bold = ifelse(player_stats$Goals > 2, TRUE, FALSE)) %>%
  column_spec(4, bold = ifelse(player_stats$Assists > 1, TRUE, FALSE)) %>%
  column_spec(6, bold = ifelse(player_stats$Saves > 10, TRUE, FALSE))
```

```{r data-source-note}
#| echo: false
#| results: asis

if (is.null(read_team_data())) {
  cat('<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #f1aeb5; text-align: center;"><strong>ðŸ“‹ Using Sample Data</strong> - Could not connect to live Google Sheet. <a href="https://docs.google.com/spreadsheets/d/1dqo2JAqRDvqtftlotC-uywJQRYlk--Yr3Azm6ZctpHQ/edit" target="_blank">View Live Sheet</a></div>')
}

cat('<div class="modal fade" id="gameDetailsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Game Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="gameDetailsContent"></div></div></div></div></div>')
```